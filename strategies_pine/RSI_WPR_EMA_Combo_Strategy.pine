// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © lijason032

//@version=5
strategy("RSI+WPR + EMA 组合策略", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=10)


// === RSI + Williams %R 参数 ===
rsiLength   = input.int(30, "RSI Length", minval=2)
wprLength   = input.int(34, "Williams %R Length", minval=2)
wprSmooth   = input.int(1, "Williams %R Smoothing", minval=1, maxval=20)

// === EMA 参数 ===
ema1Length = input.int(20, "快线 EMA 周期", minval=1)
ema2Length = input.int(50, "慢线 EMA 周期", minval=1)
calcPeriod = input.int(5, "计算周期 N", minval=1)

// === 策略开关 ===
useEmaFilter = input.bool(true, "使用 EMA 趋势过滤")
useDistanceFilter = input.bool(true, "使用距离扩张过滤")

// === RSI + Williams %R 计算 ===
rsiValue = ta.rsi(close, rsiLength)
wprRaw   = ta.wpr(wprLength)
wprValue = ta.sma(wprRaw, wprSmooth)
wprNorm = 100 + wprValue

// RSI 交叉信号
longCross  = ta.crossover(wprNorm, rsiValue)
shortCross = ta.crossunder(wprNorm, rsiValue)

// === EMA 计算 ===
ema1 = ta.ema(close, ema1Length)
ema2 = ta.ema(close, ema2Length)

// EMA 距离计算
ema1_prev = ema1[1]
ema2_prev = ema2[1]
ema1_n = ema1[calcPeriod + 1]
ema2_n = ema2[calcPeriod + 1]

distance = math.abs(ema1_prev - ema2_prev)
distance_n = math.abs(ema1_n - ema2_n)
distanceChange = distance - distance_n
isExpanding = distanceChange > 0
isContracting = distanceChange < 0

// EMA 交叉
emaLongCross = ta.crossover(ema1, ema2)
emaShortCross = ta.crossunder(ema1, ema2)

// === 绘制 ===
plot(ema1, "快线 EMA1", color=color.blue, linewidth=2)
plot(ema2, "慢线 EMA2", color=color.red, linewidth=2)

// === 多头条件 ===
rsiLong = rsiValue > 50
wprLongSignal = longCross
emaLongTrend = ema1 > ema2
distanceLongExpanding = isExpanding

longCondition = rsiLong and wprLongSignal and (not useEmaFilter or emaLongTrend) and (not useDistanceFilter or distanceLongExpanding)

// === 空头条件 ===
rsiShort = rsiValue < 50
wprShortSignal = shortCross
emaShortTrend = ema1 < ema2
distanceShortExpanding = isExpanding

shortCondition = rsiShort and wprShortSignal and (not useEmaFilter or emaShortTrend) and (not useDistanceFilter or distanceShortExpanding)

// === 入场执行 ===
if (longCondition)
    strategy.entry("多头入场", strategy.long)

if (shortCondition)
    strategy.entry("空头入场", strategy.short)

// === 出场条件 ===
// RSI 回到中性区域
rsiExitLong = rsiValue < 45
rsiExitShort = rsiValue > 55

// EMA 距离开始收缩
distanceContract = isContracting and not isContracting[1]

if (rsiExitLong or distanceContract)
    strategy.close("多头入场")

if (rsiExitShort or distanceContract)
    strategy.close("空头入场")


// === 图表标记 ===
plotshape(longCondition, title="Long Signal", style=shape.triangleup, 
          location=location.bottom, color=color.green, size=size.small, text="BUY")
plotshape(shortCondition, title="Short Signal", style=shape.triangledown, 
          location=location.top, color=color.red, size=size.small, text="SELL")


// === 信息面板 ===
var table infoTable = table.new(position.top_right, 2, 6, 
     border_width=1, 
     border_color=color.gray, 
     frame_width=1, 
     frame_color=color.gray)

if barstate.islast
    table.cell(infoTable, 0, 0, "指标", text_color=color.white, bgcolor=color.new(color.gray, 30), text_size=size.small)
    table.cell(infoTable, 1, 0, "数值", text_color=color.white, bgcolor=color.new(color.gray, 30), text_size=size.small)
    
    table.cell(infoTable, 0, 1, "RSI", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 1, str.tostring(rsiValue, "#.##"), 
         text_color=rsiValue > 50 ? color.lime : color.red, text_size=size.small)
    
    table.cell(infoTable, 0, 2, "WPR(标准化)", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 2, str.tostring(wprNorm, "#.##"), text_color=color.orange, text_size=size.small)
    
    table.cell(infoTable, 0, 3, "EMA距离趋势", text_color=color.white, text_size=size.small)
    trendText = isExpanding ? "扩张 ↗" : isContracting ? "收缩 ↘" : "持平 →"
    trendColor = isExpanding ? color.lime : isContracting ? color.orange : color.gray
    table.cell(infoTable, 1, 3, trendText, text_color=trendColor, text_size=size.small)
    
    table.cell(infoTable, 0, 4, "多头信号", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 4, longCondition ? "✓ 触发" : "✗ 未触发", 
         text_color=longCondition ? color.lime : color.gray, text_size=size.small)
    
    table.cell(infoTable, 0, 5, "空头信号", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 5, shortCondition ? "✓ 触发" : "✗ 未触发", 
         text_color=shortCondition ? color.red : color.gray, text_size=size.small)


// === 警报 ===
alertcondition(longCondition, title="多头信号", message="RSI+WPR 多头信号触发")
alertcondition(shortCondition, title="空头信号", message="RSI+WPR 空头信号触发")
